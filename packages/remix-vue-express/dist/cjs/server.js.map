{"version":3,"file":"server.js","sources":["../../server.js"],"sourcesContent":["import {\r\n  createRequestHandler as createRemixVueRequestHandler,\r\n  createReadableStreamFromReadable,\r\n  writeReadableStreamToWritable,\r\n} from \"@remix-vue/node\";\r\n\r\nexport function createRequestHandler({\r\n  build,\r\n  getLoadContext,\r\n  mode = process.env.NODE_ENV,\r\n}) {\r\n  let handleRequest = createRemixVueRequestHandler(build, mode);\r\n\r\n  return async (req, res, next) => {\r\n    try {\r\n      let request = createRemixVueRequest(req, res);\r\n      let loadContext = await getLoadContext?.(req, res);\r\n\r\n      let response = await handleRequest(request, loadContext);\r\n\r\n      await sendRemixVueResponse(res, response);\r\n    } catch (error) {\r\n      // Express doesn't support async functions, so we have to pass along the\r\n      // error manually using next().\r\n      next(error);\r\n    }\r\n  };\r\n}\r\n\r\nexport function createRemixVueHeaders(requestHeaders) {\r\n  let headers = new Headers();\r\n\r\n  for (let [key, values] of Object.entries(requestHeaders)) {\r\n    if (values) {\r\n      if (Array.isArray(values)) {\r\n        for (let value of values) {\r\n          headers.append(key, value);\r\n        }\r\n      } else {\r\n        headers.set(key, values);\r\n      }\r\n    }\r\n  }\r\n\r\n  return headers;\r\n}\r\n\r\nexport function createRemixVueRequest(req, res) {\r\n  // req.hostname doesn't include port information so grab that from\r\n  // `X-Forwarded-Host` or `Host`\r\n  let [, hostnamePort] = req.get(\"X-Forwarded-Host\")?.split(\":\") ?? [];\r\n  let [, hostPort] = req.get(\"host\")?.split(\":\") ?? [];\r\n  let port = hostnamePort || hostPort;\r\n  // Use req.hostname here as it respects the \"trust proxy\" setting\r\n  let resolvedHost = `${req.hostname}${port ? `:${port}` : \"\"}`;\r\n  let url = new URL(`${req.protocol}://${resolvedHost}${req.url}`);\r\n\r\n  // Abort action/loaders once we can no longer write a response\r\n  let controller = new AbortController();\r\n  res.on(\"close\", () => controller.abort());\r\n\r\n  let init = {\r\n    method: req.method,\r\n    headers: createRemixVueHeaders(req.headers),\r\n    signal: controller.signal,\r\n  };\r\n\r\n  if (req.method !== \"GET\" && req.method !== \"HEAD\") {\r\n    init.body = createReadableStreamFromReadable(req);\r\n    init.duplex = \"half\";\r\n  }\r\n\r\n  return new Request(url.href, init);\r\n}\r\n\r\nexport async function sendRemixVueResponse(res, nodeResponse) {\r\n  res.statusMessage = nodeResponse.statusText;\r\n  res.status(nodeResponse.status);\r\n\r\n  for (let [key, value] of nodeResponse.headers.entries()) {\r\n    res.append(key, value);\r\n  }\r\n\r\n  if (nodeResponse.headers.get(\"Content-Type\")?.match(/text\\/event-stream/i)) {\r\n    res.flushHeaders();\r\n  }\r\n\r\n  if (nodeResponse.body) {\r\n    await writeReadableStreamToWritable(nodeResponse.body, res);\r\n  } else {\r\n    res.end();\r\n  }\r\n}\r\n"],"names":["createRemixVueRequestHandler","createReadableStreamFromReadable","writeReadableStreamToWritable"],"mappings":"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"}