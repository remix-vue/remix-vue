{"version":3,"file":"stream.js","sources":["../../stream.js"],"sourcesContent":["\r\nexport async function writeReadableStreamToWritable(\r\n    stream,\r\n    writable\r\n  ) {\r\n    let reader = stream.getReader();\r\n    let flushable = writable;\r\n  \r\n    try {\r\n      while (true) {\r\n        let { done, value } = await reader.read();\r\n  \r\n        if (done) {\r\n          writable.end();\r\n          break;\r\n        }\r\n  \r\n        writable.write(value);\r\n        if (typeof flushable.flush === \"function\") {\r\n          flushable.flush();\r\n        }\r\n      }\r\n    } catch (error) {\r\n      writable.destroy(error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\nexport const createReadableStreamFromReadable = (source) => {\r\n  let pump = new StreamPump(source);\r\n  let stream = new ReadableStream(pump, pump);\r\n  return stream;\r\n};\r\n\r\nclass StreamPump {\r\n  highWaterMark;\r\n  accumalatedSize;\r\n  stream = {\r\n    readableHighWaterMark: \"\",\r\n    readable: \"\",\r\n    resume: \"\",\r\n    pause: \"\",\r\n    destroy: \"\",\r\n  };\r\n  controller;\r\n\r\n  constructor(stream) {\r\n    this.highWaterMark =\r\n      stream.readableHighWaterMark ||\r\n      new Stream.Readable().readableHighWaterMark;\r\n    this.accumalatedSize = 0;\r\n    this.stream = stream;\r\n    this.enqueue = this.enqueue.bind(this);\r\n    this.error = this.error.bind(this);\r\n    this.close = this.close.bind(this);\r\n  }\r\n\r\n  size(chunk) {\r\n    return chunk?.byteLength || 0;\r\n  }\r\n\r\n  start(controller) {\r\n    this.controller = controller;\r\n    this.stream.on(\"data\", this.enqueue);\r\n    this.stream.once(\"error\", this.error);\r\n    this.stream.once(\"end\", this.close);\r\n    this.stream.once(\"close\", this.close);\r\n  }\r\n\r\n  pull() {\r\n    this.resume();\r\n  }\r\n\r\n  cancel(reason) {\r\n    if (this.stream.destroy) {\r\n      this.stream.destroy(reason);\r\n    }\r\n\r\n    this.stream.off(\"data\", this.enqueue);\r\n    this.stream.off(\"error\", this.error);\r\n    this.stream.off(\"end\", this.close);\r\n    this.stream.off(\"close\", this.close);\r\n  }\r\n\r\n  enqueue(chunk) {\r\n    if (this.controller) {\r\n      try {\r\n        let bytes = chunk instanceof Uint8Array ? chunk : Buffer.from(chunk);\r\n\r\n        let available = (this.controller.desiredSize || 0) - bytes.byteLength;\r\n        this.controller.enqueue(bytes);\r\n        if (available <= 0) {\r\n          this.pause();\r\n        }\r\n      } catch (error) {\r\n        this.controller.error(\r\n          new Error(\r\n            \"Could not create Buffer, chunk must be of type string or an instance of Buffer, ArrayBuffer, or Array or an Array-like Object\"\r\n          )\r\n        );\r\n        this.cancel();\r\n      }\r\n    }\r\n  }\r\n\r\n  pause() {\r\n    if (this.stream.pause) {\r\n      this.stream.pause();\r\n    }\r\n  }\r\n\r\n  resume() {\r\n    if (this.stream.readable && this.stream.resume) {\r\n      this.stream.resume();\r\n    }\r\n  }\r\n\r\n  close() {\r\n    if (this.controller) {\r\n      this.controller.close();\r\n      delete this.controller;\r\n    }\r\n  }\r\n\r\n  error(error) {\r\n    if (this.controller) {\r\n      this.controller.error(error);\r\n      delete this.controller;\r\n    }\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}